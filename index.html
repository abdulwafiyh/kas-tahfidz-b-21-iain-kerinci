<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kas Asrama B Tahfidz - Mobile Ready</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- VARIABEL TEMA --- */
        :root {
            --primary-color: #4361ee; --bg-body: #f2f4f8; --bg-card: #ffffff;
            --bg-header: #f8f9fa; --border-color: #dee2e6; --text-main: #212529;
            --text-muted: #6c757d; --input-hover: #f1f3f5; --input-focus: #e7f1ff;
            --shadow: rgba(0,0,0,0.05); --lunas-bg: #e8f5e9; --lunas-text: #0f5132;
            --lebih-bg: #fff8e1; --lebih-text: #664d03; --neg-bg: #ffebeb; --neg-text: #dc3545;
            --pos-bg: #e0f2f1; --pos-text: #198754;
            --cell-paid-bg: #c8e6c9; --cell-paid-text: #1b5e20;
            --cell-partial-bg: #fff3cd; --cell-partial-text: #856404;
        }
        [data-theme="dark"] {
            --primary-color: #5c7cfa; --bg-body: #121212; --bg-card: #1e1e1e;
            --bg-header: #2d2d2d; --border-color: #333333; --text-main: #e0e0e0;
            --text-muted: #a0a0a0; --input-hover: #2c2c2c; --input-focus: #1a2332;
            --shadow: rgba(0,0,0,0.5); --lunas-bg: #0f3d20; --lunas-text: #81c784;
            --lebih-bg: #423506; --lebih-text: #ffd54f; --neg-bg: #3e181b; --neg-text: #e57373;
            --pos-bg: #113326; --pos-text: #80cbc4;
            --cell-paid-bg: #1b4d3e; --cell-paid-text: #a5d6a7;
            --cell-partial-bg: #4d3e1b; --cell-partial-text: #ffe082;
        }

        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-body); margin: 0; padding: 15px; color: var(--text-main); font-size: 13px; transition: 0.3s; padding-bottom: 140px; }
        .container { max-width: 100%; background: var(--bg-card); border-radius: 12px; box-shadow: 0 4px 20px var(--shadow); overflow: hidden; margin-bottom: 20px; }
        
        /* HEADER */
        .header-section { padding: 20px; background: linear-gradient(135deg, #4361ee, #3f37c9); color: white; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; }
        .header-titles { display: flex; flex-direction: column; gap: 2px; flex: 1; min-width: 250px; }
        .header-titles h1 { margin: 0; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; line-height: 1.3; }
        .header-titles h2 { margin: 0; font-size: 13px; font-weight: 500; opacity: 0.9; margin-top: 5px; }
        .header-titles h3 { margin: 0; font-size: 11px; font-weight: 400; opacity: 0.7; }
        .header-controls { display: flex; align-items: center; gap: 8px; margin-top: 5px; flex-wrap: wrap; }
        
        /* TABLE STYLES */
        .table-wrapper { overflow-x: auto; max-height: 65vh; position: relative; scrollbar-width: thin; -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */ }
        table { border-collapse: separate; border-spacing: 0; width: max-content; }
        th, td { padding: 8px 4px; border-bottom: 1px solid var(--border-color); border-right: 1px solid var(--border-color); text-align: center; vertical-align: middle; }
        
        /* STICKY HEADERS & COLUMNS */
        thead th { background-color: var(--bg-header); color: var(--text-main); position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border-color); height: 45px; font-weight: 600; font-size: 11px; }
        /* Sticky No */
        th:nth-child(1), td:nth-child(1) { position: sticky; left: 0; background-color: var(--bg-card); z-index: 20; width: 30px; border-right: 1px solid var(--border-color); }
        /* Sticky Nama */
        th:nth-child(2), td:nth-child(2) { position: sticky; left: 30px; background-color: var(--bg-card); z-index: 20; text-align: left; padding-left: 10px; width: 140px; min-width: 140px; border-right: 2px solid var(--border-color); box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1); }
        /* Fix Z-index intersection */
        thead th:nth-child(1), thead th:nth-child(2) { z-index: 30; background-color: var(--bg-header); }

        .user-cell { display: flex; align-items: center; gap: 8px; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border-color); }
        .user-name { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }

        /* INPUTS */
        input[type="number"] { width: 50px; padding: 8px 0; border: 1px solid transparent; background: transparent; text-align: center; color: var(--text-main); pointer-events: none; border-radius: 6px; font-weight: 500; font-size: 13px; }
        input.is-paid { background-color: var(--cell-paid-bg) !important; color: var(--cell-paid-text) !important; font-weight: 700; }
        input.is-partial { background-color: var(--cell-partial-bg) !important; color: var(--cell-partial-text) !important; }
        
        body.is-admin input[type="number"] { pointer-events: auto; }
        body.is-admin input[type="number"]:not(.is-paid):not(.is-partial) { border-bottom: 1px dashed var(--border-color); }
        body.is-admin input[type="number"]:focus { background-color: var(--input-focus) !important; outline: none; border: 1px solid var(--primary-color); }

        /* FOOTER */
        .floating-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-card); padding: 12px 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); display: flex; justify-content: space-between; align-items: center; z-index: 100; border-top: 1px solid var(--border-color); flex-wrap: wrap; gap: 5px; }
        .stat-item { display: flex; flex-direction: column; min-width: 80px; }
        .stat-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }
        .stat-val { font-size: 14px; font-weight: 700; color: var(--text-main); }
        .text-green { color: var(--pos-text); } .text-red { color: var(--neg-text); }

        /* BUTTONS */
        .btn { padding: 6px 12px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; border-radius: 6px; cursor: pointer; font-size: 11px; }
        .admin-badge { display: none; background: #00e676; color: #003300; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-left: 5px; vertical-align: middle; }
        body.is-admin .admin-badge { display: inline-block; }
        body.is-admin .btn-login { display: none; }
        .btn-logout { display: none; background: rgba(220,53,69,0.8); border:none; }
        body.is-admin .btn-logout { display: inline-block; }

        /* TRANSACTIONS */
        .section-title { padding: 12px 15px; font-weight: 600; font-size: 13px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-card); }
        .trans-form { display: none; padding: 15px; gap: 8px; background: var(--input-hover); border-bottom: 1px solid var(--border-color); flex-direction: column; }
        body.is-admin .trans-form { display: flex; }
        .form-input { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-card); color: var(--text-main); font-size: 14px; width: 100%; box-sizing: border-box; }
        .btn-add { background: var(--primary-color); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: 600; }
        .btn-delete { background: var(--neg-text); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; display: none; }
        body.is-admin .btn-delete { display: inline-block; }

        .trans-table th { text-align: left; padding: 10px; background: var(--bg-header); font-size: 11px; color: var(--text-muted); }
        .trans-table td { padding: 10px; border-bottom: 1px solid var(--border-color); font-size: 12px; }
        .type-in { color: var(--pos-text); font-weight: 600; background: rgba(25, 135, 84, 0.1); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        .type-out { color: var(--neg-text); font-weight: 600; background: rgba(220, 53, 69, 0.1); padding: 2px 6px; border-radius: 4px; font-size: 10px; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-content { max-width: 90%; max-height: 80%; border-radius: 8px; animation: zoom 0.3s; }
        .rules-modal { background: var(--bg-card); padding: 25px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; color: var(--text-main); border-radius: 12px; }
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 30px; color: white; cursor: pointer; }
        
        /* --- MOBILE RESPONSIVE TWEAKS --- */
        @media (max-width: 600px) {
            .header-titles h1 { font-size: 16px; }
            .header-controls { width: 100%; justify-content: space-between; margin-top: 10px; }
            .shortcuts-info { display: none; } /* Hide shortcut info on mobile to save space */
            .floating-footer { flex-direction: row; flex-wrap: wrap; justify-content: space-between; }
            .floating-footer .stat-item { flex: 1; text-align: center; margin-bottom: 5px; }
            .floating-footer .stat-item:last-child { flex: 100%; border-top: 1px solid var(--border-color); padding-top: 5px; margin-top: 5px; }
            .stat-val { font-size: 13px; }
            #real-balance { font-size: 18px; }
            .user-name { max-width: 70px; font-size: 11px; }
            th:nth-child(2), td:nth-child(2) { width: 110px; min-width: 110px; left: 30px; }
        }

        @keyframes zoom { from {transform:scale(0.9); opacity: 0;} to {transform:scale(1); opacity: 1;} }
    </style>
</head>
<body>

<div class="container" style="margin-bottom: 15px;">
    <div class="header-section">
        <div class="header-titles">
            <h1>Kas Asrama Angkatan 21 <span class="admin-badge">ADMIN</span></h1>
            <h2>Mahasantri Ma'had Al-Jamiah</h2>
            <h3>IAIN Kerinci Tahun 2025/2026</h3>
        </div>
        <div class="header-controls">
            <div class="shortcuts-info">Minggu 1: 5k | Next: 2k</div>
            <button class="btn" onclick="openRules()">ðŸ“œ Aturan</button>
            <button class="btn btn-login" onclick="adminLogin()">Login</button>
            <button class="btn btn-logout" onclick="adminLogout()">Keluar</button>
            <button class="btn" onclick="toggleTheme()">ðŸŒ“</button>
        </div>
    </div>
</div>

<div class="container" style="padding: 0;">
    <div class="section-title">
        <span>Rekap Iuran</span>
        <span style="font-size: 10px; opacity: 0.6;">Geser tabel ke kanan â†’</span>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>No</th>
                    <th>Nama</th>
                    </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<div class="container" style="padding: 0;">
    <div class="section-title">
        <span>Buku Kas Umum</span>
    </div>
    
    <div class="trans-form">
        <input type="date" id="t-date" class="form-input">
        <input type="text" id="t-desc" placeholder="Keterangan (Cth: Beli Sapu)" class="form-input">
        <select id="t-type" class="form-input">
            <option value="out">ðŸ”´ Pengeluaran</option>
            <option value="in">ðŸŸ¢ Pemasukan Lain</option>
        </select>
        <input type="number" id="t-amount" placeholder="Nominal (Rp)" class="form-input">
        <button onclick="addTransaction()" class="btn-add">SIMPAN TRANSAKSI</button>
    </div>

    <div style="max-height: 300px; overflow-y: auto;">
        <table class="trans-table" style="width: 100%;">
            <tbody id="trans-body">
                <tr><td colspan="5" style="text-align:center; padding:20px; color:var(--text-muted);">Memuat data...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="floating-footer">
    <div class="stat-item">
        <span class="stat-label">Masuk</span>
        <span class="stat-val text-green" id="total-student-fees">Rp 0</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">Keluar</span>
        <span class="stat-val text-red" id="total-expenses">Rp 0</span>
    </div>
    <div class="stat-item">
        <span class="stat-label" style="color:var(--primary-color)">SISA SALDO REAL</span>
        <span class="stat-val" id="real-balance" style="font-size: 18px; color: var(--primary-color);">Rp 0</span>
    </div>
</div>

<div id="imageModal" class="modal" onclick="closeModal('imageModal')">
    <span class="close-modal" onclick="closeModal('imageModal')">&times;</span>
    <img class="modal-content" id="img01">
    <div id="caption" style="color:white; margin-top:10px; font-weight: 500;"></div>
</div>

<div id="rulesModal" class="modal">
    <div class="rules-modal">
        <span class="close-modal" style="color:var(--text-main); top:15px; right:15px; font-size:24px;" onclick="closeModal('rulesModal')">&times;</span>
        <h2 style="margin-bottom:20px;">ðŸ“œ Aturan Kas</h2>
        <p><strong>1. Iuran:</strong> Awal Rp5.000, Mingguan Rp2.000.</p>
        <p><strong>2. Penggunaan:</strong> Sosial (40%), Operasional (30%), Kegiatan (20%), Darurat (10%).</p>
        <p><strong>3. Sanksi:</strong> Menunggak >4 minggu akan ditandai.</p>
        <br>
        <div style="text-align:center; font-size:11px; color:grey;">Disepakati 17 Nov 2025</div>
    </div>
</div>

<script>
    // --- 1. CONFIG FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyC1LLUqM7fpWBi64RYNikxv0myBCbeYVfA",
      authDomain: "kas-tahfidz-b-21-iain-ke-a49e7.firebaseapp.com",
      databaseURL: "https://kas-tahfidz-b-21-iain-ke-a49e7-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kas-tahfidz-b-21-iain-ke-a49e7",
      storageBucket: "kas-tahfidz-b-21-iain-ke-a49e7.firebasestorage.app",
      messagingSenderId: "958192304792",
      appId: "1:958192304792:web:70502398346daac16d86ed"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. DATA ---
    const STUDENTS = ["Asyrafa", "Damar", "Fahri", "Fatur", "Geo", "Hengki", "Pujangga", "Rhafino", "Wafiy", "Zaki"];
    const START_DATE = new Date("2025-11-17");
    const TOTAL_WEEKS = 37;
    const formatRp = (num) => "Rp " + num.toLocaleString('id-ID');

    // --- 3. RENDER TABLE ---
    const headerRow = document.querySelector('thead tr');
    let currentDate = new Date(START_DATE);
    headerRow.innerHTML = '<th>No</th><th>Nama</th>'; 
    for (let i = 1; i <= TOTAL_WEEKS; i++) {
        const dateStr = currentDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'numeric' });
        const th = document.createElement('th');
        th.style.minWidth = '55px';
        th.innerHTML = `<div style="font-size:8px; opacity:0.6">${i}</div><div style="font-size:10px">${dateStr}</div>`;
        headerRow.appendChild(th);
        currentDate.setDate(currentDate.getDate() + 7);
    }

    const tbody = document.getElementById('table-body');
    STUDENTS.forEach((name, index) => {
        const rowId = index + 1;
        const tr = document.createElement('tr');
        const avatarUrl = `foto/${name}.jpeg`; 
        const imgError = `this.onerror=null;this.src='https://ui-avatars.com/api/?name=${name}&background=random&color=fff&size=64';`;
        
        let html = `<td>${rowId}</td><td><div class="user-cell"><img src="${avatarUrl}" class="user-avatar" onerror="${imgError}" onclick="showImage(this.src, '${name}')"><span class="user-name">${name}</span></div></td>`;
        for (let i = 1; i <= TOTAL_WEEKS; i++) {
            html += `<td><input type="number" id="pay-${index}-${i}" placeholder="-" 
                    onchange="savePayment(${index}, ${i}, this.value)" 
                    oninput="checkColor(this, ${i})" onfocus="this.select()"></td>`;
        }
        tr.innerHTML = html;
        tbody.appendChild(tr);
    });

    // --- 4. FIREBASE LOGIC ---
    let totalStudentIncome = 0;
    let totalOtherIncome = 0;
    let totalExpenses = 0;

    // Payments
    db.ref('payments').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        totalStudentIncome = 0;
        STUDENTS.forEach((_, sIndex) => {
            for (let w = 1; w <= TOTAL_WEEKS; w++) {
                const input = document.getElementById(`pay-${sIndex}-${w}`);
                const val = (data[sIndex] && data[sIndex][w]) ? data[sIndex][w] : 0;
                if (input.value != val && document.activeElement !== input) input.value = val > 0 ? val : '';
                checkColor(input, w);
                totalStudentIncome += parseInt(val) || 0;
            }
        });
        updateFooter();
    });

    // Transactions
    db.ref('transactions').on('value', (snapshot) => {
        const transBody = document.getElementById('trans-body');
        transBody.innerHTML = '';
        totalOtherIncome = 0; totalExpenses = 0;
        const data = snapshot.val();
        
        if (data) {
            const entries = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);
            entries.forEach(([key, val]) => {
                const row = document.createElement('tr');
                const isExpense = val.type === 'out';
                const sign = isExpense ? '- ' : '+ ';
                if (isExpense) totalExpenses += val.amount; else totalOtherIncome += val.amount;

                row.innerHTML = `
                    <td style="font-size:11px">${new Date(val.date).toLocaleDateString('id-ID', {day:'numeric', month:'numeric'})}</td>
                    <td style="font-weight:500; font-size:12px;">${val.desc}</td>
                    <td><span class="${isExpense ? 'type-out' : 'type-in'}">${isExpense ? 'Keluar' : 'Masuk'}</span></td>
                    <td class="${isExpense ? 'text-red' : 'text-green'}" style="font-weight:700">${sign}${formatRp(val.amount)}</td>
                    <td><button class="btn-delete" onclick="deleteTransaction('${key}')">Ã—</button></td>
                `;
                transBody.appendChild(row);
            });
        } else {
            transBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; font-size:12px; color:grey;">Belum ada data.</td></tr>';
        }
        updateFooter();
    });

    // --- 5. FUNCTIONS ---
    function savePayment(s, w, v) {
        if (v === '2') v = 2000; if (v === '5') v = 5000; if (v === '') v = 0;
        const input = document.getElementById(`pay-${s}-${w}`);
        input.value = v;
        checkColor(input, w);
        db.ref(`payments/${s}/${w}`).set(parseInt(v));
    }

    function checkColor(input, weekIndex) {
        const val = parseInt(input.value) || 0;
        const target = (weekIndex === 1) ? 5000 : 2000;
        input.classList.remove('is-paid', 'is-partial');
        if (val >= target) input.classList.add('is-paid');
        else if (val > 0) input.classList.add('is-partial');
    }

    function addTransaction() {
        const date = document.getElementById('t-date').value;
        const desc = document.getElementById('t-desc').value;
        const type = document.getElementById('t-type').value;
        const amount = parseInt(document.getElementById('t-amount').value);
        if (!desc || !amount) { alert("Lengkapi data!"); return; }
        db.ref('transactions').push({ date, desc, type, amount, timestamp: firebase.database.ServerValue.TIMESTAMP });
        document.getElementById('t-desc').value = ''; document.getElementById('t-amount').value = '';
    }

    function deleteTransaction(key) {
        if (confirm("Hapus?")) db.ref('transactions').child(key).remove();
    }

    function updateFooter() {
        const real = (totalStudentIncome + totalOtherIncome) - totalExpenses;
        document.getElementById('total-student-fees').textContent = formatRp(totalStudentIncome);
        document.getElementById('total-expenses').textContent = formatRp(totalExpenses);
        document.getElementById('real-balance').textContent = formatRp(real);
    }

    // --- 6. AUTHENTICATION (BASE64) ---
    function adminLogin() {
        const pass = prompt("Password Admin:");
        if (!pass) return;
        // Password: 
        if (btoa(pass) === "YWRtaW5nYW50ZW5nMjE=") {
            document.body.classList.add("is-admin"); localStorage.setItem("isAdmin", "true");
            alert("Login Sukses!");
        } else { alert("Salah!"); }
    }
    function adminLogout() {
        if (confirm("Keluar?")) {
            document.body.classList.remove("is-admin"); localStorage.removeItem("isAdmin");
            location.reload();
        }
    }
    if (localStorage.getItem("isAdmin") === "true") document.body.classList.add("is-admin");

    // --- UI UTILS ---
    function openRules() { document.getElementById('rulesModal').style.display = 'flex'; }
    function showImage(src, name) {
        document.getElementById('imageModal').style.display = 'flex';
        document.getElementById('img01').src = src;
        document.getElementById('caption').textContent = name;
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onclick = function(e) { if (e.target.classList.contains('modal')) e.target.style.display = "none"; }
    function toggleTheme() {
        const html = document.documentElement;
        if (html.getAttribute('data-theme') === 'dark') { html.removeAttribute('data-theme'); localStorage.setItem('theme', 'light'); } 
        else { html.setAttribute('data-theme', 'dark'); localStorage.setItem('theme', 'dark'); }
    }
    if (localStorage.getItem('theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
    document.getElementById('t-date').valueAsDate = new Date();
</script>
</body>
</html>

