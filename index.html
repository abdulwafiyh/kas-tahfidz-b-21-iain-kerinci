<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kas Asrama B Tahfidz - Pro Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- VARIABEL TEMA PRO --- */
        :root {
            --primary: #4361ee; --primary-dark: #3046c4;
            --bg-body: #f4f7fa; --bg-card: #ffffff;
            --border: #eaecf0; --text-main: #101828; --text-sub: #667085;
            --input-bg: #f9fafb; --input-focus: #ffffff;
            --shadow-sm: 0 1px 2px rgba(16, 24, 40, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(16, 24, 40, 0.1), 0 2px 4px -1px rgba(16, 24, 40, 0.06);
            
            /* Status Colors */
            --success-bg: #ecfdf5; --success-text: #027a48;
            --warn-bg: #fffbeb; --warn-text: #b54708;
            --danger-bg: #fef2f2; --danger-text: #b42318;
            --info-bg: #eff8ff; --info-text: #175cd3;

            /* Cell Colors */
            --paid-bg: #d1fadf; --paid-text: #054f31;
            --partial-bg: #fef0c7; --partial-text: #93370d;
            --current-week-bg: #fff9db; /* Warna Highlight Minggu Ini */
        }

        [data-theme="dark"] {
            --primary: #5c7cfa; --primary-dark: #4263eb;
            --bg-body: #0f1115; --bg-card: #181b21;
            --border: #2d333b; --text-main: #f0f6fc; --text-sub: #8b949e;
            --input-bg: #21262d; --input-focus: #0d1117;
            --shadow-sm: none; --shadow-md: none;
            
            --success-bg: #0f291e; --success-text: #3fb950;
            --warn-bg: #282109; --warn-text: #d29922;
            --danger-bg: #2e0f12; --danger-text: #f85149;
            --info-bg: #0d1926; --info-text: #58a6ff;

            --paid-bg: #113524; --paid-text: #7ee787;
            --partial-bg: #372b08; --partial-text: #f2cc60;
            --current-week-bg: #292408;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); margin: 0; padding: 15px; color: var(--text-main); font-size: 13px; padding-bottom: 140px; -webkit-font-smoothing: antialiased; }
        .container { max-width: 100%; background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow-md); overflow: hidden; margin-bottom: 20px; border: 1px solid var(--border); }
        
        /* HEADER PRO */
        .header-section { padding: 24px; background: linear-gradient(145deg, var(--primary), var(--primary-dark)); color: white; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; position: relative; overflow: hidden; }
        /* Dekorasi Header */
        .header-section::after { content: ''; position: absolute; right: -20px; top: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; }
        
        .header-titles { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 250px; z-index: 2; }
        .header-titles h1 { margin: 0; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; letter-spacing: -0.02em; }
        .header-titles h2 { margin: 0; font-size: 13px; font-weight: 500; opacity: 0.9; }
        .header-titles h3 { margin: 0; font-size: 11px; font-weight: 400; opacity: 0.75; }
        .header-controls { display: flex; align-items: center; gap: 8px; margin-top: 5px; flex-wrap: wrap; z-index: 2; }
        
        /* TABLE STYLES REFINED */
        .table-wrapper { overflow-x: auto; max-height: 65vh; position: relative; scrollbar-width: thin; scroll-behavior: smooth; }
        /* Custom Scrollbar */
        .table-wrapper::-webkit-scrollbar { height: 6px; width: 6px; }
        .table-wrapper::-webkit-scrollbar-track { background: var(--bg-body); }
        .table-wrapper::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        table { border-collapse: separate; border-spacing: 0; width: max-content; }
        th, td { padding: 8px 4px; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); text-align: center; vertical-align: middle; transition: background 0.1s; }
        
        /* Zebra Striping & Hover */
        tbody tr:nth-child(even) td { background-color: var(--bg-body); } 
        tbody tr:hover td { background-color: var(--input-bg); } /* Highlight row on hover */

        /* Sticky Logic */
        thead th { background-color: var(--bg-header); color: var(--text-sub); position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border); height: 42px; font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; backdrop-filter: blur(5px); }
        
        /* Sticky Columns Left */
        th:nth-child(1), td:nth-child(1) { position: sticky; left: 0; background-color: var(--bg-card); z-index: 20; width: 30px; border-right: 1px solid var(--border); }
        th:nth-child(2), td:nth-child(2) { position: sticky; left: 30px; background-color: var(--bg-card); z-index: 20; text-align: left; padding-left: 12px; width: 120px; min-width: 120px; border-right: 2px solid var(--border); box-shadow: 2px 0 5px -2px rgba(0,0,0,0.05); }
        
        /* Zebra fix for sticky columns */
        tbody tr:nth-child(even) td:nth-child(1), tbody tr:nth-child(even) td:nth-child(2) { background-color: var(--bg-body); }
        tbody tr:hover td:nth-child(1), tbody tr:hover td:nth-child(2) { background-color: var(--input-bg); }

        thead th:nth-child(1), thead th:nth-child(2) { z-index: 30; background-color: var(--bg-header); }

        /* FOOTER TABLE STICKY */
        tfoot td { position: sticky; bottom: 0; background-color: var(--bg-header); font-weight: 700; font-size: 10px; color: var(--primary); border-top: 2px solid var(--border); z-index: 25; padding: 6px; box-shadow: 0 -2px 5px rgba(0,0,0,0.03); }
        tfoot td:first-child { position: sticky; left: 0; z-index: 35; background-color: var(--bg-header); text-align: right; padding-right: 12px; color: var(--text-main); border-right: 2px solid var(--border); }

        /* CURRENT WEEK HIGHLIGHT */
        .current-week-head { background-color: var(--current-week-bg) !important; border-bottom: 2px solid var(--warn-text) !important; color: var(--warn-text) !important; }
        .current-week-cell { background-color: var(--current-week-bg) !important; }

        .user-cell { display: flex; align-items: center; gap: 8px; }
        .user-avatar { width: 26px; height: 26px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); transition: transform 0.2s; }
        .user-avatar:hover { transform: scale(1.5); }
        .user-name { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90px; }

        /* RED MARK (NUNGGAK) */
        .is-late { position: relative; color: var(--danger-text) !important; font-weight: 700; }
        .is-late::before { content: '‚ö†Ô∏è'; font-size: 10px; margin-right: 4px; display: inline-block; animation: pulse 2s infinite; }
        .is-late .user-name { text-decoration: underline; text-decoration-color: var(--danger-text); text-decoration-style: dotted; }

        /* INPUTS */
        input[type="number"] { width: 42px; padding: 6px 0; border: 1px solid transparent; background: transparent; text-align: center; color: var(--text-main); pointer-events: none; border-radius: 6px; font-weight: 500; font-size: 12px; font-family: 'Inter', sans-serif; }
        input.is-paid { background-color: var(--paid-bg) !important; color: var(--paid-text) !important; font-weight: 700; border: 1px solid rgba(0,0,0,0.05); }
        input.is-partial { background-color: var(--partial-bg) !important; color: var(--partial-text) !important; }
        
        body.is-admin input[type="number"] { pointer-events: auto; cursor: text; }
        body.is-admin input[type="number"]:not(.is-paid):not(.is-partial) { border-bottom: 1px dashed var(--border); }
        body.is-admin input[type="number"]:focus { background-color: var(--input-focus) !important; outline: none; border: 1px solid var(--primary); box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1); transform: scale(1.05); }

        /* FORM TRANSAKSI GRID */
        .section-title { padding: 16px 20px; font-weight: 600; font-size: 14px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-card); color: var(--text-main); }
        
        .trans-form-container { display: none; padding: 20px; background: var(--bg-card); border-bottom: 1px solid var(--border); }
        body.is-admin .trans-form-container { display: block; animation: slideDown 0.3s ease; }

        .trans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-label { font-size: 11px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input { padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main); font-size: 13px; width: 100%; box-sizing: border-box; transition: all 0.2s; outline: none; }
        .form-input:focus { border-color: var(--primary); background: var(--input-focus); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); }
        .full-width { grid-column: span 2; } 
        .btn-add { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; font-size: 13px; margin-top: 5px; transition: 0.2s; box-shadow: 0 2px 4px rgba(67, 97, 238, 0.3); }
        .btn-add:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-add:active { transform: translateY(0); }

        /* TABEL TRANSAKSI */
        .trans-table th { text-align: left; padding: 12px 15px; background: var(--bg-header); font-size: 11px; color: var(--text-sub); text-transform: uppercase; }
        .trans-table td { padding: 12px 15px; border-bottom: 1px solid var(--border); font-size: 12px; }
        .type-in { color: var(--success-text); font-weight: 600; background: var(--success-bg); padding: 4px 10px; border-radius: 20px; font-size: 10px; border: 1px solid rgba(2, 122, 72, 0.1); }
        .type-out { color: var(--danger-text); font-weight: 600; background: var(--danger-bg); padding: 4px 10px; border-radius: 20px; font-size: 10px; border: 1px solid rgba(180, 35, 24, 0.1); }
        .btn-delete { background: var(--danger-bg); color: var(--danger-text); border: 1px solid rgba(180, 35, 24, 0.2); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 10px; display: none; transition: 0.2s; }
        .btn-delete:hover { background: var(--danger-text); color: white; }
        body.is-admin .btn-delete { display: inline-block; }

        /* FOOTER (FLOATING) */
        .floating-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 12px 5px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); display: flex; justify-content: center; gap: 15px; align-items: center; z-index: 100; border-top: 1px solid var(--border); flex-wrap: wrap; }
        [data-theme="dark"] .floating-footer { background: rgba(24, 27, 33, 0.9); }
        
        .stat-item { display: flex; flex-direction: column; align-items: center; padding: 0 5px; }
        .stat-item:not(:last-child) { border-right: 1px solid var(--border); padding-right: 15px; }
        .stat-label { font-size: 10px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; margin-bottom: 3px; letter-spacing: 0.5px; }
        .stat-val { font-size: 14px; font-weight: 700; color: var(--text-main); font-variant-numeric: tabular-nums; }
        .text-green { color: var(--success-text); } .text-red { color: var(--danger-text); } .text-blue { color: var(--info-text); } .text-orange { color: var(--warn-text); }

        /* BUTTONS */
        .btn { padding: 6px 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.15); color: white; border-radius: 6px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .btn:hover { background: rgba(255,255,255,0.25); }
        .admin-badge { display: none; background: #00e676; color: #003300; padding: 3px 8px; border-radius: 12px; font-size: 10px; margin-left: 8px; vertical-align: middle; font-weight: 700; letter-spacing: 0.5px; box-shadow: 0 2px 4px rgba(0,230,118,0.2); }
        body.is-admin .admin-badge { display: inline-block; }
        body.is-admin .btn-login { display: none; }
        .btn-logout { display: none; background: rgba(220,53,69,0.9); border:none; }
        body.is-admin .btn-logout { display: inline-block; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-content { max-width: 90%; max-height: 80%; border-radius: 12px; animation: zoom 0.3s; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .rules-modal { background: var(--bg-card); padding: 25px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; color: var(--text-main); border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-md); }
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 24px; color: var(--text-sub); cursor: pointer; z-index: 10; transition: 0.2s; }
        .close-modal:hover { color: var(--danger-text); transform: rotate(90deg); }
        
        /* MOBILE TWEAKS */
        @media (max-width: 600px) {
            .header-titles h1 { font-size: 16px; }
            .header-controls { width: 100%; justify-content: space-between; margin-top: 15px; }
            .shortcuts-info { display: none; }
            .floating-footer { gap: 10px; justify-content: space-evenly; }
            .stat-item:not(:last-child) { border: none; padding-right: 0; }
            .stat-val { font-size: 13px; }
            .stat-label { font-size: 9px; }
            .saldo-container { flex-basis: 100%; text-align: center; margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border); }
            #real-balance { font-size: 18px; }
            .user-name { max-width: 70px; font-size: 11px; }
            th:nth-child(2), td:nth-child(2) { width: 105px; min-width: 105px; left: 30px; }
            tfoot td:first-child { width: 105px; left: 0; padding-right: 8px; }
            .trans-grid { grid-template-columns: 1fr; gap: 12px; }
            .full-width { grid-column: auto; }
        }

        @keyframes zoom { from {transform:scale(0.95); opacity: 0;} to {transform:scale(1); opacity: 1;} }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }
    </style>
</head>
<body>

<div class="container" style="margin-bottom: 20px;">
    <div class="header-section">
        <div class="header-titles">
            <h1>Kas Asrama Angkatan 21 <span class="admin-badge">ADMIN MODE</span></h1>
            <h2>Mahasantri Ma'had Al-Jamiah</h2>
            <h3>IAIN Kerinci Tahun 2025/2026</h3>
        </div>
        <div class="header-controls">
            <div class="shortcuts-info">Minggu 1: 5k | Next: 2k</div>
            <button class="btn" onclick="openRules()">üìú Aturan</button>
            <button class="btn btn-login" onclick="adminLogin()">Login</button>
            <button class="btn btn-logout" onclick="adminLogout()">Keluar</button>
            <button class="btn" onclick="toggleTheme()">üåì</button>
        </div>
    </div>
</div>

<div class="container" style="padding: 0;">
    <div class="section-title">
        <span>Rekap Iuran</span>
        <span style="font-size: 11px; opacity: 0.7; font-weight: 400;">Geser tabel ke kanan ‚Üí</span>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>No</th>
                    <th>Nama</th>
                    </tr>
            </thead>
            <tbody id="table-body"></tbody>
            <tfoot id="table-foot"></tfoot>
        </table>
    </div>
</div>

<div class="container" style="padding: 0;">
    <div class="section-title">
        <span>Buku Kas Umum</span>
    </div>
    
    <div class="trans-form-container">
        <div class="trans-grid">
            <div class="form-group">
                <span class="form-label">Tanggal</span>
                <input type="date" id="t-date" class="form-input">
            </div>
            
            <div class="form-group">
                <span class="form-label">Jenis Transaksi</span>
                <select id="t-type" class="form-input" style="appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23212529%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 12px center; background-size: 10px;">
                    <option value="out">üî¥ Pengeluaran</option>
                    <option value="in">üü¢ Pemasukan Lain</option>
                </select>
            </div>

            <div class="form-group full-width">
                <span class="form-label">Keterangan</span>
                <input type="text" id="t-desc" placeholder="Contoh: Beli Sapu, Fotokopi..." class="form-input" autocomplete="off">
            </div>

            <div class="form-group full-width">
                <span class="form-label">Nominal (Rp)</span>
                <input type="number" id="t-amount" placeholder="0" class="form-input" style="font-weight: 700;">
            </div>
            
            <div class="full-width">
                <button onclick="addTransaction()" class="btn-add">SIMPAN TRANSAKSI</button>
            </div>
        </div>
    </div>

    <div style="max-height: 350px; overflow-y: auto;">
        <table class="trans-table" style="width: 100%;">
            <tbody id="trans-body">
                <tr><td colspan="5" style="text-align:center; padding:30px; color:var(--text-sub);">Memuat data...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="floating-footer">
    <div class="stat-item">
        <span class="stat-label">Target</span>
        <span class="stat-val text-blue" id="target-fees">Rp 0</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">Masuk</span>
        <span class="stat-val text-green" id="total-student-fees">Rp 0</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">Kurang</span>
        <span class="stat-val text-orange" id="defisit-fees">Rp 0</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">Keluar</span>
        <span class="stat-val text-red" id="total-expenses">Rp 0</span>
    </div>
    <div class="stat-item saldo-container">
        <span class="stat-label" style="color:var(--primary);">SISA SALDO</span>
        <span class="stat-val" id="real-balance" style="font-size: 16px; color: var(--primary);">Rp 0</span>
    </div>
</div>

<div id="imageModal" class="modal" onclick="closeModal('imageModal')">
    <span class="close-modal" onclick="closeModal('imageModal')">&times;</span>
    <img class="modal-content" id="img01">
    <div id="caption" style="color:white; margin-top:10px; font-weight: 500; text-align: center;"></div>
</div>

<div id="rulesModal" class="modal">
    <div class="rules-modal">
        <span class="close-modal" onclick="closeModal('rulesModal')">&times;</span>
        <div style="text-align:center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px;">
            <h2 style="margin:0; font-size:18px; color:var(--primary);">üìú TATA TERTIB & ATURAN KAS</h2>
            <p style="margin:5px 0 0 0; font-size:11px; color:var(--text-sub);">ASRAMA B TAHFIDZ ANGKATAN KE-21</p>
        </div>
        <div class="rules-content" style="font-size: 12px; text-align: justify; line-height: 1.6; color: var(--text-main);">
            <h3>BAB I: KETENTUAN UMUM</h3>
            <p><strong>Pasal 1:</strong> Uang Kas Asrama B Tahfidz Angkatan ke-21 adalah dana kebersamaan yang dikumpulkan dari, oleh, dan untuk kepentingan seluruh anggota angkatan ke-21 demi menunjang kegiatan sosial, kebersihan, dan kebutuhan operasional asrama.</p>
            <h3>BAB II: SUMBER DANA</h3>
            <p><strong>Pasal 2:</strong> Sumber dana kas berasal dari:</p>
            <ul><li><strong>Iuran Pokok Awal:</strong> Rp5.000 pada minggu pertama (17 Nov 2025).</li><li><strong>Iuran Wajib Mingguan:</strong> Rp2.000 per minggu (Jumat/Ahad).</li><li><strong>Donasi Sukarela:</strong> Sumbangan tidak mengikat.</li><li><strong>Denda:</strong> Sanksi keterlambatan (jika disepakati).</li></ul>
            <h3>BAB III: PENGGUNAAN DANA</h3>
            <p><strong>Pasal 3:</strong> Pos pengeluaran:</p>
            <h4>1. Dana Sosial & Ukhuwah (40%)</h4>
            <ul><li><strong>Menjenguk Sakit:</strong> Rawat inap/sakit berat >3 hari (Max: Rp[...]).</li><li><strong>Berita Duka:</strong> Keluarga inti (Ayah/Ibu) meninggal.</li><li><strong>Prestasi:</strong> Apresiasi Khataman 30 Juz.</li></ul>
            <h4>2. Operasional & Kebersihan (30%)</h4>
            <ul><li>Alat kebersihan (Sapu, Pel) saat habis/rusak.</li><li>Inventaris (Galon, Karpet, dll).</li><li>Fotokopi/cetak materi kolektif.</li></ul>
            <h4>3. Kegiatan Angkatan (20%)</h4>
            <ul><li>Subsidi makan bersama (Liwetan).</li><li>Biaya tak terduga acara angkatan (Rihlah).</li></ul>
            <h4>4. Dana Darurat / Saving (10%)</h4>
            <ul><li>Dana cadangan mendesak masa depan.</li></ul>
            <h3>BAB IV: MEKANISME PENGELOLAAN</h3>
            <p><strong>Pasal 4:</strong></p>
            <ul><li><strong>Penarikan:</strong> Bendahara menagih setiap minggu.</li><li><strong>Penyimpanan:</strong> Tunai/Bank & dicatat di Web/Spreadsheet.</li><li><strong>Pengeluaran:</strong> Wajib persetujuan Ketua & ada Nota (kecuali pasar).</li></ul>
            <h3>BAB V: PELAPORAN</h3>
            <p><strong>Pasal 5:</strong></p>
            <ul><li>Update data setiap ada transaksi.</li><li>Laporan rekapitulasi dibagikan setiap akhir bulan.</li><li>Akses transparansi terbuka (Web ini).</li></ul>
            <h3>BAB VI: SANKSI DAN DENDA</h3>
            <p><strong>Pasal 6:</strong></p>
            <ul><li>Menunggak >2 minggu: Teguran lisan.</li><li>Menunggak >1 bulan (4 minggu): <span style="color:var(--danger-text); font-weight:bold;">Ditandai Merah</span> di laporan.</li><li>(Opsional) Infaq seikhlasnya jika telat tanpa uzur.</li></ul>
            <h3>BAB VII: PENUTUP</h3>
            <p>Hal yang belum diatur diputuskan lewat musyawarah.</p>
            <br><div style="text-align:center; font-style:italic; opacity:0.8; color:var(--text-sub);"><div>Ditetapkan: 17 November 2025</div><br><div style="display:flex; justify-content:space-around;"><div>Mengetahui,<br><br>( Ketua Angkatan )</div><div>Mengetahui,<br><br>( Bendahara )</div></div></div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIG FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyC1LLUqM7fpWBi64RYNikxv0myBCbeYVfA",
      authDomain: "kas-tahfidz-b-21-iain-ke-a49e7.firebaseapp.com",
      databaseURL: "https://kas-tahfidz-b-21-iain-ke-a49e7-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kas-tahfidz-b-21-iain-ke-a49e7",
      storageBucket: "kas-tahfidz-b-21-iain-ke-a49e7.firebasestorage.app",
      messagingSenderId: "958192304792",
      appId: "1:958192304792:web:70502398346daac16d86ed"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. DATA ---
    const STUDENTS = ["Asyrafa", "Damar", "Fahri", "Fatur", "Geo", "Hengki", "Pujangga", "Rhafino", "Wafiy", "Zaki"];
    const START_DATE = new Date("2025-11-17");
    const TOTAL_WEEKS = 37;
    const formatRp = (num) => "Rp " + num.toLocaleString('id-ID');
    const formatK = (num) => {
        if (num >= 1000) return (num/1000) + "k";
        return num;
    };

    // --- 3. LOGIC MINGGU INI (DI LUAR LOOP) ---
    const now = new Date(); now.setHours(0,0,0,0);
    const start = new Date(START_DATE); start.setHours(0,0,0,0);
    const diffDays = Math.ceil((now - start) / (1000 * 60 * 60 * 24)); 
    let currentWeekGlobal = Math.floor(diffDays / 7) + 1;
    if(currentWeekGlobal < 1) currentWeekGlobal = 1;
    // Highlight kolom minggu ini nanti di loop

    // --- 4. RENDER TABLE ---
    const headerRow = document.querySelector('thead tr');
    let currentDate = new Date(START_DATE);
    headerRow.innerHTML = '<th>No</th><th>Nama</th>'; 
    for (let i = 1; i <= TOTAL_WEEKS; i++) {
        const dateStr = currentDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'numeric' });
        const th = document.createElement('th');
        th.style.minWidth = '45px';
        
        // HIGHLIGHT HEADER MINGGU INI
        if (i === currentWeekGlobal) th.classList.add('current-week-head');

        th.innerHTML = `<div style="font-size:8px; opacity:0.7; margin-bottom:2px;">${i}</div><div style="font-size:9px">${dateStr}</div>`;
        headerRow.appendChild(th);
        currentDate.setDate(currentDate.getDate() + 7);
    }

    const tbody = document.getElementById('table-body');
    STUDENTS.forEach((name, index) => {
        const rowId = index + 1;
        const tr = document.createElement('tr');
        const avatarUrl = `foto/${name}.jpeg`; 
        const imgError = `this.onerror=null;this.src='https://ui-avatars.com/api/?name=${name}&background=random&color=fff&size=64';`;
        
        let html = `<td>${rowId}</td><td><div class="user-cell"><img src="${avatarUrl}" class="user-avatar" onerror="${imgError}" onclick="showImage(this.src, '${name}')"><span class="user-name">${name}</span></div></td>`;
        for (let i = 1; i <= TOTAL_WEEKS; i++) {
            // HIGHLIGHT CELL MINGGU INI (Agar admin tau dimana harus isi)
            let cellClass = (i === currentWeekGlobal) ? 'current-week-cell' : '';
            
            html += `<td class="${cellClass}"><input type="number" id="pay-${index}-${i}" placeholder="-" 
                    onchange="savePayment(${index}, ${i}, this.value)" 
                    oninput="checkColor(this, ${i})" onfocus="this.select()"></td>`;
        }
        tr.innerHTML = html;
        tbody.appendChild(tr);
    });

    // --- 5. RENDER FOOTER ROW ---
    const tfoot = document.getElementById('table-foot');
    const footRow = document.createElement('tr');
    footRow.innerHTML = `<td colspan="2">TOTAL</td>`;
    for (let i = 1; i <= TOTAL_WEEKS; i++) {
        footRow.innerHTML += `<td id="total-week-${i}" style="color:var(--text-sub); font-size:9px;">0</td>`;
    }
    tfoot.appendChild(footRow);

    // --- 6. FIREBASE LOGIC ---
    let totalStudentIncome = 0;
    let totalOtherIncome = 0;
    let totalExpenses = 0;

    // Payments
    db.ref('payments').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        totalStudentIncome = 0;
        let weeklySums = new Array(TOTAL_WEEKS + 1).fill(0);
        
        STUDENTS.forEach((name, sIndex) => {
            let unpaidCount = 0;

            for (let w = 1; w <= TOTAL_WEEKS; w++) {
                const input = document.getElementById(`pay-${sIndex}-${w}`);
                const val = (data[sIndex] && data[sIndex][w]) ? data[sIndex][w] : 0;
                
                if (input.value != val && document.activeElement !== input) input.value = val > 0 ? val : '';
                checkColor(input, w);
                
                let numVal = parseInt(val) || 0;
                totalStudentIncome += numVal;
                weeklySums[w] += numVal;

                // Hitung Nunggak sampai minggu ini
                if (w <= currentWeekGlobal) {
                    if (!numVal || numVal == 0) unpaidCount++;
                }
            }

            // Tanda Merah (Is Late)
            const nameCell = document.querySelector(`#table-body tr:nth-child(${sIndex + 1}) td:nth-child(2)`);
            if (nameCell) {
                nameCell.classList.remove('is-late');
                if (unpaidCount > 4) nameCell.classList.add('is-late');
            }
        });

        // Update Footer Cells
        for (let w = 1; w <= TOTAL_WEEKS; w++) {
            const cell = document.getElementById(`total-week-${w}`);
            cell.textContent = formatK(weeklySums[w]);
            if(weeklySums[w] > 0) cell.style.color = "var(--primary)";
        }
        updateFooter();
    });

    // Transactions
    db.ref('transactions').on('value', (snapshot) => {
        const transBody = document.getElementById('trans-body');
        transBody.innerHTML = '';
        totalOtherIncome = 0; totalExpenses = 0;
        const data = snapshot.val();
        
        if (data) {
            const entries = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);
            entries.forEach(([key, val]) => {
                const row = document.createElement('tr');
                const isExpense = val.type === 'out';
                const sign = isExpense ? '- ' : '+ ';
                if (isExpense) totalExpenses += val.amount; else totalOtherIncome += val.amount;

                row.innerHTML = `
                    <td style="font-size:11px; color:var(--text-sub);">${new Date(val.date).toLocaleDateString('id-ID', {day:'numeric', month:'numeric'})}</td>
                    <td style="font-weight:500; font-size:12px;">${val.desc}</td>
                    <td><span class="${isExpense ? 'type-out' : 'type-in'}">${isExpense ? 'Keluar' : 'Masuk'}</span></td>
                    <td class="${isExpense ? 'text-red' : 'text-green'}" style="font-weight:700">${sign}${formatRp(val.amount)}</td>
                    <td><button class="btn-delete" onclick="deleteTransaction('${key}')">Hapus</button></td>
                `;
                transBody.appendChild(row);
            });
        } else {
            transBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; font-size:12px; color:var(--text-sub);">Belum ada transaksi.</td></tr>';
        }
        updateFooter();
    });

    // --- 7. FUNCTIONS ---
    function savePayment(s, w, v) {
        if (v === '2') v = 2000; if (v === '5') v = 5000; if (v === '') v = 0;
        const input = document.getElementById(`pay-${s}-${w}`);
        input.value = v;
        checkColor(input, w);
        db.ref(`payments/${s}/${w}`).set(parseInt(v));
    }

    function checkColor(input, weekIndex) {
        const val = parseInt(input.value) || 0;
        const target = (weekIndex === 1) ? 5000 : 2000;
        input.classList.remove('is-paid', 'is-partial');
        if (val >= target) input.classList.add('is-paid');
        else if (val > 0) input.classList.add('is-partial');
    }

    function addTransaction() {
        const date = document.getElementById('t-date').value;
        const desc = document.getElementById('t-desc').value;
        const type = document.getElementById('t-type').value;
        const amount = parseInt(document.getElementById('t-amount').value);
        if (!desc || !amount) { alert("Lengkapi data!"); return; }
        db.ref('transactions').push({ date, desc, type, amount, timestamp: firebase.database.ServerValue.TIMESTAMP });
        document.getElementById('t-desc').value = ''; document.getElementById('t-amount').value = '';
    }

    function deleteTransaction(key) {
        if (confirm("Hapus transaksi ini?")) db.ref('transactions').child(key).remove();
    }

    function updateFooter() {
        const targetAmount = 770000; 
        let deficit = targetAmount - totalStudentIncome;
        if (deficit < 0) deficit = 0;
        const real = (totalStudentIncome + totalOtherIncome) - totalExpenses;
        
        document.getElementById('target-fees').textContent = formatRp(targetAmount);
        document.getElementById('total-student-fees').textContent = formatRp(totalStudentIncome);
        document.getElementById('defisit-fees').textContent = formatRp(deficit);
        document.getElementById('total-expenses').textContent = formatRp(totalExpenses);
        document.getElementById('real-balance').textContent = formatRp(real);
    }

    // --- AUTH ---
    function adminLogin() {
        const pass = prompt("Password Admin:");
        if (!pass) return;
        if (btoa(pass) === "YWRtaW5nYW50ZW5nMjE=") {
            document.body.classList.add("is-admin"); localStorage.setItem("isAdmin", "true");
            alert("Mode Admin Aktif!");
        } else { alert("Salah!"); }
    }
    function adminLogout() {
        if (confirm("Keluar dari Mode Admin?")) {
            document.body.classList.remove("is-admin"); localStorage.removeItem("isAdmin");
            location.reload();
        }
    }
    if (localStorage.getItem("isAdmin") === "true") document.body.classList.add("is-admin");

    // --- UTILS ---
    function openRules() { document.getElementById('rulesModal').style.display = 'flex'; }
    function showImage(src, name) {
        document.getElementById('imageModal').style.display = 'flex';
        document.getElementById('img01').src = src;
        document.getElementById('caption').textContent = name;
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onclick = function(e) { if (e.target.classList.contains('modal')) e.target.style.display = "none"; }
    
    function toggleTheme() {
        const html = document.documentElement;
        if (html.getAttribute('data-theme') === 'dark') { html.removeAttribute('data-theme'); localStorage.setItem('theme', 'light'); } 
        else { html.setAttribute('data-theme', 'dark'); localStorage.setItem('theme', 'dark'); }
    }
    if (localStorage.getItem('theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
    document.getElementById('t-date').valueAsDate = new Date();
</script>
</body>
</html>
